<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR Камера</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        canvas {
            display: none;
        }
    </style>
</head>
<body>
    <script>
        async function startWebXR() {
            // Запрашиваем доступ к WebXR с разрешением на использование камеры
            const session = await navigator.xr.requestSession('immersive-ar', {
                requiredFeatures: ['camera-access']
            });

            // Создаем WebGL контекст и привязываем его к сессии WebXR
            const canvas = document.createElement('canvas');
            document.body.appendChild(canvas);
            const gl = canvas.getContext('webgl');
            const binding = new XRWebGLBinding(session, gl);

            // Запускаем цикл обновления кадров
            session.requestAnimationFrame(async function onFrame(time, xrFrame) {
                const viewerPose = xrFrame.getViewerPose(xrReferenceSpace);

                for (const view of viewerPose.views) {
                    if (view.camera) {
                        // Получаем текстуру изображения с камеры
                        const cameraTexture = binding.getCameraImage(view.camera);

                        // Создаем новый холст для изображения с камеры
                        canvas.width = view.viewport.width;
                        canvas.height = view.viewport.height;
                        const ctx = canvas.getContext('2d');
                        const imageData = new Uint8Array(canvas.width * canvas.height * 4);
                        gl.readPixels(0, 0, canvas.width, canvas.height, gl.RGBA, gl.UNSIGNED_BYTE, imageData);

                        // Рисуем данные изображения на холсте
                        const imageDataObj = new ImageData(new Uint8ClampedArray(imageData), canvas.width, canvas.height);
                        ctx.putImageData(imageDataObj, 0, 0);

                        // Создаем ссылку для скачивания изображения
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = 'camera-image.png';
                        link.click();
                    }
                }

                // Запрашиваем следующий кадр
                session.requestAnimationFrame(onFrame);
            });
        }

        // Проверяем, поддерживает ли браузер WebXR
        if (navigator.xr) {
            startWebXR().catch(console.error);
        } else {
            alert('WebXR не поддерживается в вашем браузере.');
        }
    </script>
</body>
</html>
